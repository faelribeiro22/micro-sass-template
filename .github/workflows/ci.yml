name: âœ… CI - Build e Testes

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-and-type-check:
    name: ðŸ” Lint e Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ” TypeScript Check
        run: npx tsc --noEmit

  build:
    name: ðŸ”¨ Build
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ”¨ Build
        run: npm run build

      - name: ðŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .output
          retention-days: 7

  test:
    name: ðŸ§ª Testes
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ðŸ§ª Executar testes
        run: npm test

  security-audit:
    name: ðŸ”’ Auditoria de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ”’ NPM Audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ðŸ“ Audit Report
        if: always()
        run: |
          echo "## ðŸ”’ RelatÃ³rio de SeguranÃ§a" >> $GITHUB_STEP_SUMMARY
          npm audit --json | jq -r '.vulnerabilities | to_entries[] | "- \(.key): \(.value.severity)"' >> $GITHUB_STEP_SUMMARY || echo "Nenhuma vulnerabilidade encontrada" >> $GITHUB_STEP_SUMMARY

  validate-pr:
    name: âœ… ValidaÃ§Ã£o Completa
    runs-on: ubuntu-latest
    needs: [build, test, security-audit]
    if: always()
    
    steps:
      - name: âœ… Verificar status
        run: |
          if [[ "${{ needs.build.result }}" == "success" ]] && \
             [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "âœ… Todos os checks passaram!"
            exit 0
          else
            echo "âŒ Alguns checks falharam"
            exit 1
          fi

      - name: ðŸ“Š Resumo
        if: always()
        run: |
          echo "## ðŸ“Š Resumo da CI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint & Type Check | ${{ needs.lint-and-type-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Testes | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ SeguranÃ§a | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
